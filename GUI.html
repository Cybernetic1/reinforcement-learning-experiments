<!DOCTYPE html>
<!-- This works with "node ws.mjs" running as Websocket server -->
<html>
<head>
	<title>Tic Tac Toe GUI</title>
<style>
table {
	border: 2px solid black;
	table-layout: fixed;
	}
td.sq {
	text-align: center; 
	vertical-align: middle;
	border: 2px solid black;
	width: 50px;
	height: 50px;
	overflow: hidden;
	font-size: 25px;
	}
td.SQ {
	text-align: center; 
	vertical-align: middle;
	border: 2px solid black;
	border-bottom-style: none;
	width: 70px;
	height: 50px;
	overflow: hidden;
	font-size: 25px;
	}
td.Value {
	text-align: right;
	border: 1px solid black;
	width: 70px;
	height: 20px;
	}
td.mem {
	text-align: center;
	border: 2px solid black;
	width: 30px;
	height: 30px;
	}
td.Mem {
	text-align: right;
	border: 2px solid black;
	width: 70px;
	height: 25px;
	}
input[type=radio] {
	transform: scale(2);
	}
</style>
</head>
<body>

<button onclick="sendTestMsg()">test Websocket</button>
<br>

<h1><input type="radio" id="TTT" name="selector">
&nbsp; TicTacToe GUI</h1>

<table>
	<tr>
		<td class='sq' id='sq0'></td>
		<td class='sq' id='sq1'></td>
		<td class='sq' id='sq2'></td>
	</tr>
	<tr>
		<td class='sq' id='sq3'></td>
		<td class='sq' id='sq4'></td>
		<td class='sq' id='sq5'></td>
	</tr>
	<tr>
		<td class='sq' id='sq6'></td>
		<td class='sq' id='sq7'></td>
		<td class='sq' id='sq8'></td>
	</tr>
</table>

<h3>Memory:</h3>

<table id="memory">
	<tr>
		<td class='mem' id='m0'></td>
		<td class='mem' id='m1'></td>
		<td class='mem' id='m2'></td>
		<td class='mem' id='m3'></td>
		<td class='mem' id='m4'></td>
		<td class='mem' id='m5'></td>
		<td class='mem' id='m6'></td>
		<td class='mem' id='m7'></td>
		<td class='mem' id='m8'></td>
	</tr>
</table>

<br><br><hr>

<h1><input type="radio" id="QQQ" name="selector" checked>
&nbsp; Visualization of Q values</h1>

<p>Click on square to change piece.</p>
<p><font color="green">Green color</font> indicates probability.</p>

<table id="board2">
	<tr>
		<td class='SQ' id='SQ0'></td>
		<td class='SQ' id='SQ1'></td>
		<td class='SQ' id='SQ2'></td>
	</tr>
	<tr>
		<td class='Value' id='v0'></td>
		<td class='Value' id='v1'></td>
		<td class='Value' id='v2'></td>
	</tr>
	<tr>
		<td class='SQ' id='SQ3'></td>
		<td class='SQ' id='SQ4'></td>
		<td class='SQ' id='SQ5'></td>
	</tr>
	<tr>
		<td class='Value' id='v3'></td>
		<td class='Value' id='v4'></td>
		<td class='Value' id='v5'></td>
	</tr>
	<tr>
		<td class='SQ' id='SQ6'></td>
		<td class='SQ' id='SQ7'></td>
		<td class='SQ' id='SQ8'></td>
	</tr>
	<tr>
		<td class='Value' id='v6'></td>
		<td class='Value' id='v7'></td>
		<td class='Value' id='v8'></td>
	</tr>
</table>

<h3>Memory:</h3>

<table id="memory2">
	<tr>
		<td class='Mem' id='M0'></td>
		<td class='Mem' id='M1'></td>
		<td class='Mem' id='M2'></td>
		<td class='Mem' id='M3'></td>
		<td class='Mem' id='M4'></td>
		<td class='Mem' id='M5'></td>
		<td class='Mem' id='M6'></td>
		<td class='Mem' id='M7'></td>
		<td class='Mem' id='M8'></td>
	</tr>
</table>

<!-- p id="gameOver" style="color:red; font-size:40px; display:none">Game Over</p-->

<ul id="messages"></ul>

<script>
	var ws = new WebSocket("ws://127.0.0.1:5678/");
	// const messages = document.getElementById('messages');
	// const gameOver = document.getElementById('gameOver');
	var state = new Array(9).fill(0);

	ws.onmessage = function (event) {
		// gameOver.style.display = 'none';
		const data = JSON.parse(event.data);
		// console.log("data =", data);
		if (typeof(data) == 'number')
			document.getElementById('TTT').checked = true;
		else if (data.length == 9)
			document.getElementById('TTT').checked = true;

		if (document.getElementById('QQQ').checked) {
			for (let i = 0; i < 9; i++) {
				const v = document.getElementById('v' + i.toString());
				const sq = document.getElementById('SQ' + i.toString());
				v.innerText = data[i].toFixed(5).toString();
				var shade = ((100 - data[i] * 100) * .6 + 40).toString();
				sq.style.backgroundColor = "hsl(128,100%," + shade + "%)";
				v.style.backgroundColor = "hsl(128,100%," + shade + "%)";
				}
			for (let i = 0; i < 9; i++) {
				const m = document.getElementById('M' + i.toString());
				m.innerText = data[9 + i].toFixed(5).toString();
				var shade = ((100 - data[9 + i] * 100) * .6 + 40).toString();
				m.style.backgroundColor = "hsl(128,100%," + shade + "%)";
				}
			}

		if (document.getElementById('TTT').checked) {
			if (typeof(data) == 'number') {
				if (data > 8) {
					const i = data - 9;
					console.log(i);
					const m = document.getElementById('m' + i.toString());
					m.textContent = '⨯';
					m.style.backgroundColor = 'green';
					}
				else {
					for (let j = 0; j < 9; j++) {
						const m = document.getElementById('m' + j.toString());
						m.textContent = '';
						m.style.backgroundColor = 'white';
						}
					const i = data;
					const sq = document.getElementById('sq' + i.toString());
					sq.textContent = '⨯';
					sq.style.backgroundColor = 'green';
					}
				}
			else {
				for (let i = 0; i < 9; i++) {
					const sq = document.getElementById('sq' + i.toString());
					sq.textContent = data[i] == -1 ? '⨯' :
						data[i] == 1 ? '⭘' :
						data[i] == 2 ? '!' : ' ';
					sq.style.backgroundColor = data[i] == 2 ? 'red' :
						data[i] == 1 ? 'white' :
						data[i] == -1 ? 'green' : 'white';
					}
				}
			}
		/* var message = document.createElement('li'),
			content = document.createTextNode(event.data);
		message.appendChild(content);
		messages.appendChild(message);  */
	};

	function sendTestMsg() {
		ws.send("Hi, from the client");
		}

	for (let i = 0; i < 9; i++) {
		const sq = document.getElementById('SQ' + i.toString());
		sq.onclick = function() {
			if (sq.innerText == '') {
				state[i] = -1;
				sq.innerText = '⨯';
				}
			else if (sq.innerText == '⨯') {
				state[i] = 1;
				sq.innerText = '⭘';
				}
			else if (sq.innerText == '⭘') {
				state[i] = 0;
				sq.innerText = '';
				}
			// send state to RL algorithm:
			ws.send(JSON.stringify(state));
			// then RL sends logits to us...
			}
		}

</script>
</body>
</html>
